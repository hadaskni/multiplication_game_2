<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×›×•×›×‘×™ ×”×›×¤×œ - ×œ×•××“×™× ×•×§×•× ×™×</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Varela+Round&display=swap');
        body {
            font-family: 'Varela Round', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
            padding: 1rem;
        }
        .screen { display: none; }
        .screen.active { display: block; }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1.5rem;
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.1);
            border: 4px solid white;
            min-height: 70vh;
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 100%;
            padding: 1rem;
        }
        
        @media (min-width: 768px) {
            .card {
                border-radius: 2.5rem;
                border: 8px solid white;
                min-height: 550px;
                padding: 2rem;
            }
        }

        .option-btn {
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-bottom: 4px solid #e2e8f0;
        }
        .option-btn:active {
            transform: translateY(4px);
            border-bottom-width: 0;
        }

        /* ×¡×’× ×•×Ÿ ×œ×›×¤×ª×•×¨ × ×‘×—×¨ */
        .option-btn.selected {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-color: #1d4ed8; /* blue-700 */
            border-bottom-width: 4px;
        }
        
        .coin-animation {
            animation: coinPop 0.5s ease-out forwards;
        }
        @keyframes coinPop {
            0% { transform: scale(0) translateY(0); opacity: 0; }
            50% { transform: scale(1.5) translateY(-50px); opacity: 1; }
            100% { transform: scale(1) translateY(-100px); opacity: 0; }
        }

        .ltr { direction: ltr; unicode-bidi: bidi-override; }

        @keyframes swallow {
            0% { transform: scale(1) translateY(0); opacity: 1; }
            40% { transform: scale(1.3) translateY(20px); opacity: 1; }
            100% { transform: scale(0) translateY(120px); opacity: 0; }
        }
        .item-swallow {
            animation: swallow 0.8s cubic-bezier(0.5, 0, 0.5, 1) forwards;
        }

        @keyframes animalReaction {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15) translateY(-10px); }
        }
        .animal-react {
            animation: animalReaction 0.5s ease-in-out;
        }

        .item-float {
            animation: float 2s infinite ease-in-out;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .meter-fill {
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            border: 2px solid white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
            z-index: 60;
        }
        .control-btn:hover {
            transform: scale(1.05);
        }
        .control-btn:active {
            transform: scale(0.95);
        }

        .trophy-bounce {
            animation: trophyBounce 1s cubic-bezier(0.36, 0, 0.66, -0.56) infinite alternate;
        }
        @keyframes trophyBounce {
            0% { transform: translateY(0) scale(1); }
            100% { transform: translateY(-10px) scale(1.05); }
        }
    </style>
</head>
<body>

    <div class="max-w-xl w-full mx-auto relative">
        <!-- Top Bar -->
        <div class="fixed top-2 left-2 right-2 z-50 flex justify-between items-start pointer-events-none px-1">
            <!-- Left: Wallet & Meters -->
            <div class="flex flex-col gap-1 pointer-events-auto">
                <div class="bg-white/90 backdrop-blur px-3 py-1 rounded-full border-2 border-yellow-400 shadow-lg flex items-center gap-2 w-fit transform scale-90 origin-top-left md:scale-100">
                    <span class="text-lg">ğŸ’°</span>
                    <span id="total-wallet" class="font-black text-yellow-700 text-lg">0</span>
                </div>
                <div class="flex flex-col gap-1 transform scale-90 origin-top-left md:scale-100">
                    <div class="bg-white/90 backdrop-blur px-2 py-1 rounded-xl border-2 border-red-100 shadow-md flex flex-col gap-0.5 w-24">
                        <div class="flex justify-between items-center text-[8px] font-bold text-red-600">
                            <span>×©×•×‘×¢</span>
                            <span>ğŸ</span>
                        </div>
                        <div class="h-1.5 bg-slate-200 rounded-full overflow-hidden">
                            <div id="hunger-meter" class="meter-fill h-full bg-red-500" style="width: 10%"></div>
                        </div>
                        <div id="hunger-val" class="text-[8px] text-center text-red-800 font-mono leading-none">10/100</div>
                    </div>
                    <div class="bg-white/90 backdrop-blur px-2 py-1 rounded-xl border-2 border-pink-100 shadow-md flex flex-col gap-0.5 w-24">
                        <div class="flex justify-between items-center text-[8px] font-bold text-pink-600">
                            <span>×¨×’×©×•×ª</span>
                            <span>â¤ï¸</span>
                        </div>
                        <div class="h-1.5 bg-slate-200 rounded-full overflow-hidden">
                            <div id="happiness-meter" class="meter-fill h-full bg-pink-500" style="width: 10%"></div>
                        </div>
                        <div id="happiness-val" class="text-[8px] text-center text-pink-800 font-mono leading-none">10/100</div>
                    </div>
                </div>
            </div>

            <!-- Right: Navigation -->
            <div class="flex gap-1.5 pointer-events-auto">
                <button onclick="goToShop()" class="control-btn p-2 rounded-full text-slate-600 hover:text-purple-600 hover:border-purple-200" title="×—× ×•×ª ×”×—×™×•×ª">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                </button>
                <button onclick="goToSettings()" class="control-btn p-2 rounded-full text-slate-600 hover:text-blue-600 hover:border-blue-200" title="×”×’×“×¨×•×ª ×ª×¨×’×•×œ">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
                <button onclick="goToHome()" class="control-btn p-2 rounded-full text-slate-600 hover:text-emerald-600 hover:border-emerald-200" title="×—×–×¨×” ×œ××¡×š ×”×¨××©×™">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="card text-center relative mt-20 md:mt-24 mx-auto">
            
            <!-- Screen: Animal Select (Initial) -->
            <div id="screen-animal" class="screen active w-full">
                <h2 class="text-2xl md:text-3xl font-black text-slate-800 mb-6 mt-2 text-center">×‘×—×¨ ×—×‘×¨ ×œ×“×¨×š!</h2>
                <div class="grid grid-cols-3 gap-3 md:gap-4">
                    <button onclick="selectAnimal('dog')" class="option-btn bg-blue-50 hover:bg-blue-100 p-4 md:p-6 rounded-3xl border-2 border-blue-200">
                        <span class="text-4xl md:text-6xl block mb-2">ğŸ¶</span>
                        <span class="font-bold text-blue-600 text-sm md:text-base">×›×œ×‘×œ×‘</span>
                    </button>
                    <button onclick="selectAnimal('cat')" class="option-btn bg-pink-50 hover:bg-pink-100 p-4 md:p-6 rounded-3xl border-2 border-pink-200">
                        <span class="text-4xl md:text-6xl block mb-2">ğŸ±</span>
                        <span class="font-bold text-pink-600 text-sm md:text-base">×—×ª×œ×ª×•×œ</span>
                    </button>
                    <button onclick="selectAnimal('rabbit')" class="option-btn bg-emerald-50 hover:bg-emerald-100 p-4 md:p-6 rounded-3xl border-2 border-emerald-200">
                        <span class="text-4xl md:text-6xl block mb-2">ğŸ°</span>
                        <span class="font-bold text-emerald-600 text-sm md:text-base">××¨× ×‘</span>
                    </button>
                </div>
            </div>

            <!-- Screen: Lobby -->
            <div id="screen-lobby" class="screen w-full">
                <h2 class="text-2xl md:text-3xl font-black text-slate-800 mb-2 mt-4 text-center">×”×‘×™×ª ×©×œ×™</h2>
                <div class="flex flex-col items-center justify-center min-h-[250px] md:min-h-[300px]">
                    <div id="lobby-animal-icon" class="h-40 w-40 md:h-48 md:w-48 flex items-center justify-center text-8xl md:text-9xl transition-all mb-4"></div>
                    <div id="lobby-mood-text" class="text-lg md:text-xl font-bold text-slate-500 bg-slate-100 px-4 py-1 rounded-full text-center">××¦×‘ ×¨×•×—: ...</div>
                </div>
                
                <div class="grid grid-cols-1 gap-3 mt-4 w-full">
                    <button onclick="goToSettings()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-4 rounded-2xl shadow-xl text-lg md:text-xl flex items-center justify-center gap-2">
                        <span>â–¶ï¸</span> ×”×ª×—×œ ×ª×¨×’×•×œ
                    </button>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="openShop()" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-2xl shadow-md text-sm md:text-base">
                            ğŸ›ï¸ ×œ×—× ×•×ª
                        </button>
                        <button onclick="showScreen('screen-animal')" class="bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold py-3 rounded-2xl shadow-md text-sm md:text-base">
                            ğŸ”„ ×”×—×œ×£ ×—×™×”
                        </button>
                    </div>
                </div>
            </div>

            <!-- Screen: Factor Select (Multi-Select) -->
            <div id="screen-factor" class="screen w-full relative">
                <button onclick="goBack('screen-lobby')" class="absolute top-0 right-0 text-slate-400 hover:text-slate-600 p-2 text-sm font-bold">âœ ×—×–×•×¨</button>
                <h2 class="text-2xl md:text-3xl font-black text-slate-800 mb-2 mt-6 text-center">×‘×—×¨ ××” ×œ×ª×¨×’×œ:</h2>
                <p class="text-sm text-slate-500 mb-6">××¤×©×¨ ×œ×‘×—×•×¨ ×›××” ×‘×™×—×“!</p>
                
                <div id="factor-grid" class="grid grid-cols-4 gap-2 md:gap-3 mb-6 place-content-center">
                    <!-- Buttons generated by JS -->
                </div>
                
                <button id="btn-continue-mode" onclick="showScreen('screen-mode')" class="w-full bg-slate-300 text-white font-black py-4 rounded-2xl shadow-lg text-lg md:text-xl transition-all" disabled>
                    ×”××©×š ×œ×‘×—×™×¨×ª ×¡×•×’ â”
                </button>
                
                <!-- Reset Area -->
                <div class="mt-8 text-center">
                    <button onclick="resetAllData()" class="flex items-center justify-center gap-2 mx-auto px-6 py-3 rounded-xl bg-red-50 text-red-500 hover:bg-red-100 transition-colors font-bold text-xs md:text-sm">
                        ××™×¤×•×¡ ××©×—×§ ×•×”×ª×—×œ×” ××—×“×©
                    </button>
                </div>
            </div>

            <!-- Screen: Mode Select -->
            <div id="screen-mode" class="screen w-full relative">
                <button onclick="goBack('screen-factor')" class="absolute top-0 right-0 text-slate-400 hover:text-slate-600 p-2 text-sm font-bold">âœ ×—×–×•×¨</button>
                <h2 class="text-2xl md:text-3xl font-black text-slate-800 mb-8 mt-8 text-center">×¡×•×’ ×”×ª×¨×’×™×œ×™×:</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="selectMode('mul')" class="option-btn bg-white border-2 border-slate-200 p-6 rounded-3xl hover:bg-blue-50 font-bold text-lg md:text-xl">×›×¤×œ (Ã—)</button>
                    <button onclick="selectMode('div')" class="option-btn bg-white border-2 border-slate-200 p-6 rounded-3xl hover:bg-red-50 font-bold text-lg md:text-xl">×—×™×œ×•×§ (:)</button>
                    <button onclick="selectMode('mixed')" class="option-btn bg-white border-2 border-slate-200 p-6 rounded-3xl hover:bg-purple-50 font-bold text-lg md:text-xl">××¢×•×¨×‘ (Ã—/:)</button>
                    <button onclick="selectMode('missing')" class="option-btn bg-white border-2 border-slate-200 p-6 rounded-3xl hover:bg-orange-50 font-bold text-lg md:text-xl">× ×¢×œ××™× (â–¡)</button>
                </div>
            </div>

            <!-- Screen: The Game -->
            <div id="screen-game" class="screen w-full">
                <div class="flex flex-col items-center mb-4 md:mb-6 w-full">
                    <div class="flex justify-between items-center w-full">
                        <!-- Icon container -->
                        <div class="flex flex-col items-center">
                            <div id="game-animal-icon" class="h-20 w-20 md:h-24 md:w-24 flex items-center justify-center text-5xl"></div>
                            <div id="game-mood-text" class="text-[10px] md:text-xs font-bold text-slate-500 mt-1 text-center">××¦×‘ ×¨×•×—: ×¢×¦×•×‘</div>
                        </div>
                        <div class="bg-yellow-100 px-4 py-2 rounded-full border-2 border-yellow-400 flex items-center gap-2">
                            <span class="text-xl">ğŸ’°</span>
                            <span id="session-coins" class="font-bold text-yellow-700">0</span>
                        </div>
                        <div id="progress-display" class="text-slate-400 font-bold text-xs md:text-sm text-center">×ª×¨×’×™×œ 1/12</div>
                    </div>
                </div>

                <div class="bg-slate-50 rounded-[2rem] p-6 md:p-10 mb-6 md:mb-8 border-4 border-dashed border-slate-200 relative overflow-visible w-full flex justify-center items-center">
                    <div id="coin-emitter" class="absolute inset-0 flex items-center justify-center pointer-events-none z-50"></div>
                    <div id="math-display" class="text-3xl sm:text-5xl md:text-6xl font-black text-slate-800 ltr whitespace-nowrap"></div>
                </div>

                <div id="answers-grid" class="grid grid-cols-2 gap-3 md:gap-4 ltr w-full"></div>
            </div>

            <!-- Screen: Summary -->
            <div id="screen-summary" class="screen w-full">
                <h2 id="summary-title" class="text-3xl md:text-4xl font-black text-slate-800 mb-2 mt-4 text-center">×¡×™×™××ª!</h2>
                <div id="summary-trophy" class="mb-4 md:mb-8 flex justify-center"></div>
                
                <p class="text-lg md:text-xl text-slate-600 mb-4 text-center">××¡×¤×ª ×‘×¡×‘×‘ ×–×”:</p>
                <div class="flex justify-center mb-8">
                    <div class="inline-flex items-center gap-4 bg-yellow-50 p-4 px-8 rounded-full border-4 border-yellow-400 shadow-lg">
                        <span class="text-3xl md:text-4xl">ğŸ’°</span>
                        <span id="final-session-coins" class="text-4xl md:text-5xl font-black text-yellow-600">0</span>
                    </div>
                </div>
                <div class="flex flex-col gap-3">
                    <button onclick="selectMode(state.mode)" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-4 rounded-2xl shadow-xl text-lg md:text-xl">
                        ×”××©×š ×ª×¨×’×•×œ â†º
                    </button>
                    <button onclick="openShop()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-black py-4 rounded-2xl shadow-xl text-lg md:text-xl flex items-center justify-center gap-2">
                        ×œ×—× ×•×ª ğŸ›’
                    </button>
                </div>
            </div>

            <!-- Screen: Shop -->
            <div id="screen-shop" class="screen w-full relative">
                <button onclick="goBack('screen-lobby')" class="absolute top-0 right-0 text-slate-400 hover:text-slate-600 p-2 text-sm font-bold">âœ ×—×–×•×¨</button>
                <h2 class="text-2xl md:text-3xl font-black text-slate-800 mb-4 md:mb-6 mt-8 text-center">×—× ×•×ª ×”×—×™×•×ª ğŸ›ï¸</h2>
                <div class="flex gap-2 mb-4 md:mb-6">
                    <button onclick="showShopTab('food')" id="tab-food" class="flex-1 py-2 rounded-xl font-bold border-2 border-blue-500 bg-blue-500 text-white transition-all text-sm md:text-base">××•×›×œ ğŸ</button>
                    <button onclick="showShopTab('toys')" id="tab-toys" class="flex-1 py-2 rounded-xl font-bold border-2 border-blue-100 text-blue-400 transition-all text-sm md:text-base">×©×¢×©×•×¢×™× ğŸ§¸</button>
                </div>
                <div id="shop-items" class="grid grid-cols-2 gap-3 h-[280px] overflow-y-auto p-2 border-2 border-slate-100 rounded-2xl bg-slate-50/50"></div>
            </div>

            <!-- Screen: Interaction -->
            <div id="screen-interact" class="screen w-full">
                <div class="relative py-12 flex flex-col items-center justify-center min-h-[350px] md:min-h-[440px]">
                    <div id="interact-item" class="text-7xl md:text-8xl mb-4 z-20 transition-all"></div>
                    <div id="interact-animal" class="h-32 w-32 md:h-40 md:w-40 flex items-center justify-center text-9xl z-10 mt-4 md:mt-8 transition-all"></div>
                    <div id="interact-mood-text" class="text-lg md:text-xl font-bold text-slate-500 mt-2 text-center"></div>
                    <div id="interact-text" class="mt-4 text-xl md:text-2xl font-black text-indigo-600 opacity-0 transition-opacity text-center">×™×××™!</div>
                </div>
                <button id="back-from-interact" onclick="goBack('screen-summary')" class="w-full bg-slate-800 text-white font-black py-4 rounded-2xl shadow-xl text-lg md:text-xl mt-4 opacity-0 pointer-events-none transition-opacity">×—×–×¨×”</button>
            </div>
        </div>
    </div>

    <script>
        const animalMoods = {
            dog: [
                { img: '<img src="https://i.postimg.cc/BZyvCPR5/level1.png" class="w-full h-full object-contain grayscale opacity-80" alt="×¢×¦×•×‘">', label: '×¢×¦×•×‘' },
                { img: '<img src="https://i.postimg.cc/rybp9R7N/level2.png" class="w-full h-full object-contain" alt="×¨×’×™×œ">', label: '×¨×’×™×œ' },
                { img: '<img src="https://i.postimg.cc/dQX09Zgm/level3.png" class="w-full h-full object-contain" alt="×©××—">', label: '×©××—' },
                { img: '<img src="https://i.postimg.cc/NGV0x2Z6/level4.png" class="w-full h-full object-contain" alt="×××•×©×¨">', label: '×××•×©×¨' }
            ],
            cat: [
                { img: '<img src="https://i.postimg.cc/ZCpgSQCZ/cat-level1.png" class="w-full h-full object-contain grayscale opacity-80" alt="×¢×¦×•×‘">', label: '×¢×¦×•×‘' },
                { img: '<img src="https://i.postimg.cc/vcfjsKcs/cat-level2.png" class="w-full h-full object-contain" alt="×¨×’×™×œ">', label: '×¨×’×™×œ' },
                { img: '<img src="https://i.postimg.cc/ppz7HSpt/cat-level3.png" class="w-full h-full object-contain" alt="×©××—">', label: '×©××—' },
                { img: '<img src="https://i.postimg.cc/xcM72Zcn/cat-level4.png" class="w-full h-full object-contain" alt="×××•×©×¨">', label: '×××•×©×¨' }
            ],
            rabbit: [
                { img: '<img src="https://i.postimg.cc/qgmSwKWV/rabbit-level1.png" class="w-full h-full object-contain grayscale opacity-80" alt="×¢×¦×•×‘">', label: '×¢×¦×•×‘' },
                { img: '<img src="https://i.postimg.cc/V57pgt28/rabbit-level2.png" class="w-full h-full object-contain" alt="×¨×’×™×œ">', label: '×¨×’×™×œ' },
                { img: '<img src="https://i.postimg.cc/JtTvxXSw/rabbit-level3.png" class="w-full h-full object-contain" alt="×©××—">', label: '×©××—' },
                { img: '<img src="https://i.postimg.cc/z3d67h41/rabbit-level4.png" class="w-full h-full object-contain" alt="×××•×©×¨">', label: '×××•×©×¨' }
            ]
        };

        let state = {
            totalWallet: 0,
            sessionScore: 0,
            animalType: 'dog',
            selectedFactors: [], // Array of numbers or 'twins'
            mode: '',
            currentQ: 0,
            ans: 0,
            hasMistakeInCurrentQ: false,
            hunger: 10,
            happiness: 10,
            questionPool: [],
            savedMistakes: [],
            currentScreen: 'screen-animal',
            hasPurchased: false
        };

        const shopData = {
            food: [
                { icon: 'ğŸ', name: '×ª×¤×•×—', price: 10 },
                { icon: 'ğŸ¥•', name: '×’×–×¨', price: 15 },
                { icon: 'ğŸ—', name: '×¢×•×£', price: 30 },
                { icon: 'ğŸ¦', name: '×’×œ×™×“×”', price: 25 },
                { icon: 'ğŸ•', name: '×¤×™×¦×”', price: 50 },
                { icon: 'ğŸ©', name: '×“×•× ××˜', price: 20 }
            ],
            toys: [
                { icon: 'âš½', name: '×›×“×•×¨', price: 20 },
                { icon: 'ğŸˆ', name: '×‘×œ×•×Ÿ', price: 10 },
                { icon: 'ğŸ›¹', name: '×¡×§×™×™×˜×‘×•×¨×“', price: 50 },
                { icon: 'ğŸ‘“', name: '××©×§×¤×™×™×', price: 25 },
                { icon: 'ğŸ‘‘', name: '×›×ª×¨', price: 40 },
                { icon: 'ğŸ®', name: '××©×—×§', price: 45 }
            ]
        };

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playTone(freq, type, duration, delay = 0, vol = 0.1) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.value = freq;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(audioCtx.currentTime + delay);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime + delay);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + delay + duration);
            osc.stop(audioCtx.currentTime + delay + duration);
        }

        function playSuccessSound() {
            playTone(523.25, 'sine', 0.1, 0, 0.2); 
            playTone(659.25, 'sine', 0.3, 0.1, 0.2); 
        }

        function playErrorSound() {
            playTone(150, 'triangle', 0.2, 0, 0.15);
        }

        function playFanfareSound() {
            const now = 0;
            const volume = 0.15;
            playTone(523.25, 'square', 0.1, now, volume);
            playTone(659.25, 'square', 0.1, now + 0.15, volume);
            playTone(783.99, 'square', 0.1, now + 0.3, volume);
            playTone(1046.50, 'square', 0.4, now + 0.45, volume);
        }

        function saveData() {
            localStorage.setItem('animalMathState', JSON.stringify(state));
        }

        function loadData() {
            const saved = localStorage.getItem('animalMathState');
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed };
                if(!state.savedMistakes) state.savedMistakes = [];
                if(!state.selectedFactors) state.selectedFactors = [];
                if(typeof state.hasPurchased === 'undefined') state.hasPurchased = false;
                
                if(state.hunger <= 15 && state.happiness <= 15) {
                    state.hasPurchased = false;
                }
                
                updateWalletDisplay();
                updateAnimalVisuals();
                
                // Restore factor selections on UI
                if (state.currentScreen === 'screen-factor') {
                    renderFactorButtons();
                    updateContinueButton();
                }

                if (state.currentScreen) {
                    showScreen(state.currentScreen, false);
                    if (state.currentScreen === 'screen-game') {
                        if (!state.questionPool || state.questionPool.length === 0) {
                            prepareQuestionPool();
                        }
                        updateProgressDisplay();
                        if (state.questionPool[state.currentQ - 1]) {
                             generateExerciseFromPool();
                        } else {
                            nextQuestion();
                        }
                    }
                }
            } else {
                updateWalletDisplay();
            }
        }

        function resetAllData() {
            if(confirm("×”×× ×œ××¤×¡ ××ª ×›×œ ×”× ×ª×•× ×™× (×›×¡×£, ×¨××ª ×—×™×”)?")) {
                localStorage.removeItem('animalMathState');
                location.reload();
            }
        }

        function showScreen(id, save = true) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            state.currentScreen = id;
            if (id === 'screen-factor') {
                renderFactorButtons();
                updateContinueButton();
            }
            if (save) saveData();
        }
        function goBack(id) { showScreen(id); }
        
        function goToHome() { 
            if (state.animalType) {
                updateAnimalVisuals();
                showScreen('screen-lobby');
            } else {
                showScreen('screen-animal');
            }
        }
        
        function goToSettings() { 
            // ×‘××§×•× range, ×”×•×œ×›×™× ×œ-factor ×›×™ ×”×•× ×”××¡×š ×”×¨××©×•×Ÿ ×‘×ª×”×œ×™×š ×”×—×“×©
            state.selectedFactors = []; // reset selection on new flow? Or keep? Let's keep empty for fresh start or keep existing.
            // Let's clear to force user to choose.
            state.selectedFactors = [];
            showScreen('screen-factor'); 
        }
        function goToShop() { openShop(); }

        function updateAnimalVisuals() {
            const averageMood = (state.hunger + state.happiness) / 2;
            let index = Math.floor(averageMood / 25);
            if (index > 3) index = 3;
            if (index < 0) index = 0;

            const moodData = animalMoods[state.animalType][index];
            const visual = (typeof moodData === 'string') ? moodData : moodData.img;
            const label = (typeof moodData === 'object') ? moodData.label : '';

            ['game-animal-icon', 'interact-animal', 'lobby-animal-icon'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = visual;
            });

            const moodText = document.getElementById('game-mood-text');
            if(moodText) moodText.innerText = '××¦×‘ ×¨×•×—: ' + label;
            
            const interactMoodText = document.getElementById('interact-mood-text');
            if(interactMoodText) interactMoodText.innerText = '××¦×‘ ×¨×•×—: ' + label;

            const lobbyMoodText = document.getElementById('lobby-mood-text');
            if(lobbyMoodText) lobbyMoodText.innerText = '××¦×‘ ×¨×•×—: ' + label;
        }

        function selectAnimal(type) { 
            state.animalType = type; 
            updateAnimalVisuals();
            showScreen('screen-lobby');
        }

        // New Logic for Factor Selection
        function toggleFactor(f) {
            const index = state.selectedFactors.indexOf(f);
            if (index > -1) {
                state.selectedFactors.splice(index, 1);
            } else {
                state.selectedFactors.push(f);
            }
            renderFactorButtons();
            updateContinueButton();
            saveData();
        }

        function renderFactorButtons() {
            const factorGrid = document.getElementById('factor-grid');
            factorGrid.innerHTML = ''; 
            
            // Buttons 1-10
            for (let i = 1; i <= 10; i++) {
                const b = document.createElement('button');
                const isSelected = state.selectedFactors.includes(i);
                b.className = `option-btn border-2 p-3 md:p-4 rounded-2xl font-black text-xl md:text-2xl transition-all ${isSelected ? 'selected' : 'bg-white border-slate-200 text-slate-700 hover:bg-indigo-50'}`;
                b.innerText = i;
                b.onclick = () => toggleFactor(i);
                factorGrid.appendChild(b);
            }
            
            // Twins Button
            const bTwins = document.createElement('button');
            const isTwinsSelected = state.selectedFactors.includes('twins');
            bTwins.className = `option-btn border-2 p-1 rounded-2xl font-bold text-xs md:text-sm flex flex-col items-center justify-center col-span-2 ${isTwinsSelected ? 'selected' : 'bg-indigo-50 border-indigo-200 text-indigo-600 hover:bg-indigo-100'}`;
            bTwins.innerHTML = "<span class='text-base md:text-lg'>×ª××•××™×</span><span class='text-[10px]'>2Ã—2, 3Ã—3...</span>";
            bTwins.onclick = () => toggleFactor('twins');
            factorGrid.appendChild(bTwins);
        }

        function updateContinueButton() {
            const btn = document.getElementById('btn-continue-mode');
            if (state.selectedFactors.length > 0) {
                btn.disabled = false;
                btn.classList.remove('bg-slate-300');
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            } else {
                btn.disabled = true;
                btn.classList.add('bg-slate-300');
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }
        }

        function selectMode(m) { 
            state.mode = m; 
            state.sessionScore = 0;
            state.currentQ = 0;
            document.getElementById('session-coins').innerText = 0;
            prepareQuestionPool(); 
            showScreen('screen-game');
            nextQuestion();
        }

        function prepareQuestionPool() {
            state.questionPool = [];
            const roundSize = 12; 
            let validExercises = [];

            // 1. ×§×•×“× ×›×œ × ×‘×“×•×§ ×× ×™×© ×©×’×™××•×ª ×©××•×¨×•×ª ×¨×œ×•×•× ×˜×™×•×ª ×œ×’×•×¨××™× ×©× ×‘×—×¨×•
            let relevantMistakes = [];
            if (state.savedMistakes && state.savedMistakes.length > 0) {
                const filtered = state.savedMistakes.filter(ex => {
                    // Check if the factor context of the mistake is in the currently selected factors
                    // Special case for twins
                    if (ex.factorCtx === 'twins') return state.selectedFactors.includes('twins');
                    return state.selectedFactors.includes(ex.factorCtx);
                });
                relevantMistakes = filtered.slice(0, roundSize);
                relevantMistakes.forEach(rm => {
                    const idx = state.savedMistakes.indexOf(rm);
                    if (idx > -1) state.savedMistakes.splice(idx, 1);
                });
            }

            state.questionPool = [...relevantMistakes];

            // 2. Generate exercises for selected factors
            // Loop through each selected factor
            state.selectedFactors.forEach(factor => {
                if (factor === 'twins') {
                    // Twins logic: 1x1, 2x2 ... 10x10
                    for (let i = 1; i <= 10; i++) {
                        if (['mul', 'mixed', 'missing'].includes(state.mode)) {
                            validExercises.push({ type: 'mul', n1: i, n2: i, ans: i*i, factorCtx: 'twins' });
                        }
                        // Division twins? 4:2=2, 9:3=3... essentially regular division but derived from squares
                        if (['div', 'mixed', 'missing'].includes(state.mode)) {
                            validExercises.push({ type: 'div', n1: i*i, n2: i, ans: i, factorCtx: 'twins' });
                        }
                    }
                } else {
                    const f = parseInt(factor);
                    // Regular factor logic 1-10
                    for (let i = 1; i <= 10; i++) {
                         // Multiplication
                        if (['mul', 'mixed', 'missing'].includes(state.mode)) {
                            validExercises.push({ type: 'mul', n1: f, n2: i, ans: f * i, factorCtx: f });
                        }
                        // Division
                        if (['div', 'mixed', 'missing'].includes(state.mode)) {
                            validExercises.push({ type: 'div', n1: f * i, n2: f, ans: i, factorCtx: f });
                        }
                    }
                }
            });

            // If no exercises generated (shouldn't happen if button logic works), add dummy
            if (validExercises.length === 0) {
                validExercises.push({ type: 'mul', n1: 1, n2: 1, ans: 1, factorCtx: 1 });
            }

            // 3. Fill pool
            let expandedExercises = [...validExercises];
            // Ensure we have enough for random selection if pool is small
            while (expandedExercises.length < roundSize * 2) { 
                expandedExercises = expandedExercises.concat(validExercises);
            }

            expandedExercises.sort(() => Math.random() - 0.5);

            const needed = roundSize - state.questionPool.length;
            for (let i = 0; i < needed; i++) {
                const exercise = expandedExercises[i];
                let isMissing = false;
                if (state.mode === 'missing') isMissing = true;
                
                state.questionPool.push({ ...exercise, missing: isMissing });
            }
            
            state.questionPool.sort(() => Math.random() - 0.5);
            saveData();
        }

        function updateProgressDisplay() {
            const el = document.getElementById('progress-display');
            if (el) el.innerText = '×ª×¨×’×™×œ ' + state.currentQ + '/' + state.questionPool.length;
        }

        function nextQuestion() {
            state.currentQ++;
            state.hasMistakeInCurrentQ = false;
            if (state.currentQ > state.questionPool.length) {
                state.totalWallet += state.sessionScore;
                updateWalletDisplay();
                showSummary();
                return;
            }
            updateProgressDisplay();
            generateExerciseFromPool();
            saveData();
        }

        function generateExerciseFromPool() {
            const qData = state.questionPool[state.currentQ - 1];
            if (!qData) return;
            const display = document.getElementById('math-display');
            const { type, n1, n2, ans, missing } = qData;
            state.ans = ans; 
            
            if (type === 'mul') {
                if (missing) {
                    if (Math.random() > 0.5) { display.innerText = `â–¡ Ã— ${n2} = ${ans}`; state.ans = n1; }
                    else { display.innerText = `${n1} Ã— â–¡ = ${ans}`; state.ans = n2; }
                } else {
                    display.innerText = `${n1} Ã— ${n2} = ?`;
                }
            } else if (type === 'div') {
                if (missing) {
                    if (Math.random() > 0.5) { 
                        display.innerText = `â–¡ : ${n2} = ${ans}`; 
                        state.ans = n1; 
                    } else { 
                        display.innerText = `${n1} : â–¡ = ${ans}`; 
                        state.ans = n2; 
                    }
                } else {
                    display.innerText = `${n1} : ${n2} = ?`;
                }
            }
            renderAnswers();
        }

        function renderAnswers() {
            const correctAnswer = state.ans;
            const options = new Set([correctAnswer]);
            
            // Logic to find a relevant factor for distractors
            // Try to find the factor from the current question data if available, or just use 10
            const currentQ = state.questionPool[state.currentQ - 1];
            let factor = 5; // Default fallback
            if (currentQ && currentQ.factorCtx !== 'twins') {
                 factor = parseInt(currentQ.factorCtx);
            } else {
                // For twins, use the square root or just random
                 factor = Math.floor(Math.sqrt(correctAnswer)) || 5;
            }

            while(options.size < 4) {
                let wrong;
                const strategy = Math.random();
                
                if (strategy < 0.3) {
                    wrong = correctAnswer + (Math.random() > 0.5 ? 1 : -1);
                } else if (strategy < 0.6) {
                    wrong = correctAnswer + (Math.random() > 0.5 ? factor : -factor);
                } else {
                    wrong = Math.floor(Math.random() * 101); 
                }

                if (wrong >= 0 && wrong <= 100 && !options.has(wrong)) {
                    options.add(wrong);
                }
            }
            
            const optionsArray = Array.from(options).sort(() => Math.random() - 0.5);

            const grid = document.getElementById('answers-grid');
            grid.innerHTML = '';
            optionsArray.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "option-btn bg-white border-2 border-slate-200 text-4xl font-black py-6 rounded-3xl text-slate-700 hover:bg-blue-50 shadow-sm";
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(opt, btn);
                grid.appendChild(btn);
            });
        }

        function checkAnswer(val, btn) {
            if (val === state.ans) {
                if (!state.hasMistakeInCurrentQ) {
                    state.sessionScore++;
                    document.getElementById('session-coins').innerText = state.sessionScore;
                    const emitter = document.getElementById('coin-emitter');
                    emitter.innerHTML = '<span class="text-6xl coin-animation">ğŸ’°</span>';
                }
                playSuccessSound();
                btn.className = "option-btn bg-emerald-500 text-white text-4xl font-black py-6 rounded-3xl border-emerald-700 shadow-lg";
                document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
                saveData();
                setTimeout(() => { document.getElementById('coin-emitter').innerHTML = ''; nextQuestion(); }, 700);
            } else {
                playErrorSound();
                if (!state.hasMistakeInCurrentQ) {
                    state.hasMistakeInCurrentQ = true;
                    const currentQuestion = state.questionPool[state.currentQ - 1];
                    state.savedMistakes.push(currentQuestion);
                    saveData();
                }
                btn.className = "option-btn bg-red-100 text-red-500 text-4xl font-black py-6 rounded-3xl border-red-200 opacity-50";
                btn.disabled = true;
            }
        }

        function updateWalletDisplay() {
            document.getElementById('total-wallet').innerText = state.totalWallet;
            document.getElementById('hunger-meter').style.width = state.hunger + '%';
            document.getElementById('happiness-meter').style.width = state.happiness + '%';
            document.getElementById('hunger-val').innerText = Math.round(state.hunger) + '/100';
            document.getElementById('happiness-val').innerText = Math.round(state.happiness) + '/100';
            updateAnimalVisuals();
        }

        function showSummary() {
            document.getElementById('final-session-coins').innerText = state.sessionScore;
            const trophyContainer = document.getElementById('summary-trophy');
            const titleElement = document.getElementById('summary-title');
            const score = state.sessionScore;
            const maxScore = state.questionPool.length;
            let trophyIcon = '', titleText = '', trophyClass = ''; 
            const percentage = score / maxScore;
            if (percentage === 1) { trophyIcon = 'ğŸ†'; titleText = '××•×©×œ×!'; trophyClass = 'text-9xl drop-shadow-2xl'; }
            else if (percentage >= 0.7) { trophyIcon = 'ğŸ¥ˆ'; titleText = '×›×œ ×”×›×‘×•×“!'; trophyClass = 'text-8xl'; }
            else if (percentage >= 0.4) { trophyIcon = 'ğŸ¥‰'; titleText = '×˜×•×‘ ×××•×“!'; trophyClass = 'text-7xl'; }
            else { trophyIcon = 'ğŸ…'; titleText = '×”×ª×—×œ×” ×˜×•×‘×”!'; trophyClass = 'text-6xl'; }
            trophyContainer.innerText = trophyIcon;
            trophyContainer.className = `mb-6 transition-all duration-500 ${trophyClass} trophy-bounce`;
            titleElement.innerText = titleText;
            playFanfareSound();
            showScreen('screen-summary');
        }

        function openShop() { showShopTab('food'); showScreen('screen-shop'); }

        function showShopTab(tab) {
            const foodBtn = document.getElementById('tab-food');
            const toysBtn = document.getElementById('tab-toys');
            if (tab === 'food') {
                foodBtn.className = "flex-1 py-2 rounded-xl font-bold border-2 border-blue-500 bg-blue-500 text-white";
                toysBtn.className = "flex-1 py-2 rounded-xl font-bold border-2 border-blue-100 text-blue-400";
                renderShopItems(shopData.food, 'food');
            } else {
                toysBtn.className = "flex-1 py-2 rounded-xl font-bold border-2 border-blue-500 bg-blue-500 text-white";
                foodBtn.className = "flex-1 py-2 rounded-xl font-bold border-2 border-blue-100 text-blue-400";
                renderShopItems(shopData.toys, 'toys');
            }
        }

        function renderShopItems(items, category) {
            const grid = document.getElementById('shop-items');
            grid.innerHTML = '';
            items.forEach(item => {
                const canAfford = state.totalWallet >= item.price;
                const div = document.createElement('div');
                div.className = `p-4 rounded-2xl border-2 flex flex-col items-center gap-1 transition-all ${canAfford ? 'bg-white border-slate-100 hover:border-yellow-400 cursor-pointer shadow-sm' : 'bg-slate-100 border-transparent opacity-60'}`;
                div.onclick = canAfford ? () => buyItem(item, category) : null;
                div.innerHTML = `
                    <span class="text-4xl">${item.icon}</span>
                    <span class="font-bold text-slate-800 text-sm">${item.name}</span>
                    <span class="text-xs font-black text-yellow-600 bg-yellow-50 px-2 py-0.5 rounded-full">ğŸ’° ${item.price}</span>
                `;
                grid.appendChild(div);
            });
        }

        function buyItem(item, category) {
            if (state.totalWallet < item.price) return;
            
            state.totalWallet -= item.price;
            
            let boost = (item.price / 10) * 25; 

            if (!state.hasPurchased) {
                state.hasPurchased = true;
                
                let currentStatVal = (category === 'food') ? state.hunger : state.happiness;
                let otherStatVal = (category === 'food') ? state.happiness : state.hunger;
                let currentAvg = (currentStatVal + otherStatVal) / 2;

                if (currentAvg < 25) {
                    const targetSum = 52; 
                    const neededStat = targetSum - otherStatVal;
                    const minBoost = neededStat - currentStatVal;
                    
                    if (boost < minBoost) {
                        boost = minBoost; 
                    }
                }
            }

            if (category === 'food') {
                state.hunger = Math.min(100, state.hunger + boost);
            } else {
                state.happiness = Math.min(100, state.happiness + boost);
            }
            
            saveData();
            updateWalletDisplay();
            
            const interactItem = document.getElementById('interact-item');
            const interactAnimal = document.getElementById('interact-animal');
            const interactText = document.getElementById('interact-text');
            const backBtn = document.getElementById('back-from-interact');
            
            interactItem.innerText = item.icon;
            interactItem.classList.remove('item-swallow');
            interactAnimal.classList.remove('animal-react');
            interactText.classList.add('opacity-0');
            backBtn.classList.add('opacity-0', 'pointer-events-none');
            
            showScreen('screen-interact');
            
            setTimeout(() => {
                interactItem.classList.add('item-swallow');
                setTimeout(() => {
                    interactAnimal.classList.add('animal-react');
                    interactText.innerText = (category === 'food') ? "×™×××™! ××™×–×” ×˜×¢×™×!" : "××™×–×” ×›×™×£! ×ª×•×“×”!";
                    interactText.classList.remove('opacity-0');
                    backBtn.classList.remove('opacity-0', 'pointer-events-none');
                }, 500);
            }, 300);
        }

        // Initialize Factor Grid is handled in renderFactorButtons inside loadData/showScreen
        
        window.onload = loadData;

    </script>
</body>

</html>
